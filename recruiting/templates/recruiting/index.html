{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecruitApp Agent</title>
    
    <!-- Markdown parsing and sanitization libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'recruiting/css/recruiting.css' %}">
</head>
<body>
    <div class="app-wrapper">
        <div class="chat-container">
            <div class="chat-header">
                <div class="header-left">
                    <h1>{{ user.username }}'s Recruiting Strategy</h1>
                    <div class="profile-data-snapshot">
                        {% if sport_profile %}
                            Sport: {{ sport_profile.sport.name }} | Pos: {{ sport_profile.position }} | Grad Year: {{ sport_profile.graduation_year }}
                        {% else %}
                            Update profile for personalized advice
                        {% endif %}
                    </div>
                </div>
                <div class="header-right">
                    <span id="chat-counter" style="display: none; color: var(--color-text-secondary); font-weight: 300;">0 of 3 Used</span>
                </div>
            </div>
            
            <div id="chat-view" class="main-view">
                <div id="message-list">
                </div>
                <div class="prompt-form-wrapper">
                    <form id="prompt-form" class="prompt-form">
                        {% csrf_token %}
                        <textarea name="prompt" rows="1" placeholder="Ask Coach Alex for advice..." required></textarea>
                        <button type="submit" id="send-btn" title="Send (Enter)">&uarr;</button>
                    </form>
                </div>
            </div>
            
            <div id="ledger-view" class="main-view">
                <div class="content-scroller">
                    <h2 class="view-title">The Ledger (Personalized Insights)</h2>
                    <div id="ledger-entries-container"></div>
                </div>
            </div>
            
            <div id="actions-view" class="main-view">
                <div class="content-scroller">
                    <h2 class="view-title">Action Items (Roadmap)</h2>
                    <h3 style="color: var(--color-accent); margin-bottom: 15px;">Active Tasks</h3>
                    <div id="active-actions-container"></div>
                    <h3 style="color: var(--color-text-secondary); margin-bottom: 15px;">Completed Tasks</h3>
                    <div id="completed-actions-container"></div>
                </div>
            </div>
        </div>

        <div id="sidebar">
            <h2 style="text-align: center; margin-bottom: 30px;">RecruitApp</h2>

            <nav id="global-nav">
                <a href="#" id="nav-chat" class="nav-link" title="Your Personal AI Recruiting Coach">
                    Coach Alex
                </a>
                <a href="#" id="nav-ledger" class="nav-link" title="All of your saved insights and earned knowledge gets stored here">
                    The Ledger
                </a>
                <a href="#" id="nav-actions" class="nav-link" title="Coach Alex reviews your items in The Ledger and turns your saved insights into a plan of action">
                    Game Plan
                </a>
            </nav>

            <h3 style="font-size: 1.12rem; color: var(--color-text-main); text-align: center; margin: 25px 0 15px 0; font-weight: 600; font-family: var(--font-stack);">Chat History</h3>

            <button id="new-chat-btn">
                + Start New Chat
            </button>

            <div style="text-align: center; padding: 5px 0 10px 0; color: var(--color-text-secondary); font-size: 0.85rem;">
                <span id="chat-counter-sidebar">0 of 3 Chats in Use</span>
            </div>

            <ul id="session-list"></ul>

            <!-- ADMIN CONTROLS (for users with AdminSettings) -->
            {% if user.admin_settings %}
            <div style="margin-top: auto; padding: 15px; border-top: 2px solid #6366f1;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 0.85rem; font-weight: 600; color: #a5b4fc;">Admin: Untethered Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="admin-untethered-toggle" {% if user.admin_settings.untethered_mode_enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p style="font-size: 0.7rem; color: #818cf8; margin: 0;">Remove all topic & persona constraints</p>
            </div>
            {% endif %}

            <!-- DEVELOPMENT ONLY - REMOVE BEFORE PRODUCTION -->
            <div style="margin-top: {% if user.admin_settings %}10px{% else %}auto{% endif %}; padding: 15px; border-top: 2px solid #ff4444;">
                <button id="dev-reset-btn" style="
                    width: 100%;
                    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
                    color: white;
                    border: none;
                    padding: 10px;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: all 0.2s;
                ">
                    ⚠️ RESET ALL DATA
                </button>
                <p style="
                    font-size: 0.7rem;
                    color: #ff6666;
                    margin-top: 5px;
                    margin-bottom: 15px;
                    text-align: center;
                    font-weight: 600;
                ">DEV ONLY - DESTRUCTIVE</p>
            </div>

            <!-- LOGOUT BUTTON -->
            <div style="padding: 0 15px 15px 15px;">
                <a href="{% url 'account_logout' %}" class="logout-btn" style="
                    display: block;
                    width: 100%;
                    text-align: center;
                    padding: 10px;
                    background-color: var(--color-border);
                    color: var(--color-text-main);
                    text-decoration: none;
                    border-radius: 8px;
                    font-weight: 600;
                    transition: all 0.2s;
                ">
                    Logout
                </a>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Chat Limit Reached</h3>
            <p>You've reached your limit of 3 conversations. To start a new chat, please delete an existing one, or upgrade for unlimited conversations.</p>
            <ul id="deletable-sessions-list"></ul>
            <div class="modal-buttons">
                <button id="modal-cancel-btn">Cancel</button>
                <button id="modal-upgrade-btn">Upgrade Now</button>
            </div>
        </div>
    </div>

    <div id="ledger-modal" class="modal-overlay">
        <div class="ledger-modal-content">
            <h3 style="color: var(--color-accent); font-size: 1.5rem; margin-bottom: 20px;">Save Insight to Ledger</h3>
            <p style="margin-bottom: 10px; color: var(--color-text-secondary);">Give this insight a clear, actionable title:</p>
            <input type="text" id="ledger-title-input" placeholder="e.g., 'Drafting the Initial Coach Email'">
            <p style="margin-bottom: 5px; font-weight: 600;">Insight Content (Agent's Advice):</p>
            <textarea id="ledger-content-area" rows="6" readonly"></textarea>
            <div class="modal-buttons">
                <button id="close-ledger-modal" style="background-color: var(--color-border); color: var(--color-text-main);">Cancel</button>
                <button id="confirm-save-ledger" style="background-color: var(--color-accent-dark); color: var(--color-sidebar-bg-solid); font-weight: 700;">Save to Ledger</button>
            </div>
        </div>
    </div>

    <!-- DEVELOPMENT ONLY - RESET CONFIRMATION MODAL -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content" style="border: 3px solid #ff4444;">
            <h3 style="color: #ff4444;">⚠️ NUCLEAR RESET - CONFIRM</h3>
            <p style="font-weight: 600; margin-bottom: 15px;">This will permanently delete ALL of your data:</p>
            <ul style="margin-bottom: 20px; text-align: left; line-height: 1.8;">
                <li>All chat sessions and conversations</li>
                <li>All Ledger entries</li>
                <li>All Action Items</li>
                <li>All profile information</li>
            </ul>
            <p style="margin-bottom: 10px; font-weight: 600;">Type your username to confirm:</p>
            <input type="text" id="reset-confirmation-input" placeholder="{{ user.username }}" style="
                width: 100%;
                padding: 10px;
                margin-bottom: 20px;
                border: 2px solid #ff4444;
                border-radius: 5px;
                font-size: 1rem;
            ">
            <div class="modal-buttons">
                <button id="cancel-reset-btn" style="background-color: var(--color-border); color: var(--color-text-main);">Cancel</button>
                <button id="confirm-reset-btn" style="background-color: #ff4444; color: white; font-weight: 700;">DELETE EVERYTHING</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CHAT_LIMIT = 3;
        let currentSessionId = null;
        let sessionCount = 0;
        let currentSessions = [];
        let loaderElement = null;
        let currentConversationId = null; 

        const form = document.getElementById('prompt-form');
        const messageList = document.getElementById('message-list');
        const textarea = form.querySelector('textarea');
        const sendButton = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]');
        const sessionList = document.getElementById('session-list');
        const chatCounter = document.getElementById('chat-counter');
        const chatCounterSidebar = document.getElementById('chat-counter-sidebar');
        const deleteModal = document.getElementById('delete-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const deletableSessionsList = document.getElementById('deletable-sessions-list');
        
        const mainViews = document.querySelectorAll('.main-view');
        const ledgerView = document.getElementById('ledger-view');
        const ledgerEntriesContainer = document.getElementById('ledger-entries-container');
        const activeActionsContainer = document.getElementById('active-actions-container');
        const completedActionsContainer = document.getElementById('completed-actions-container');
        
        const ledgerModal = document.getElementById('ledger-modal');
        const ledgerTitleInput = document.getElementById('ledger-title-input');
        const ledgerContentArea = document.getElementById('ledger-content-area');
        const confirmSaveLedger = document.getElementById('confirm-save-ledger');
        const closeLedgerModal = document.getElementById('close-ledger-modal');
        
        const navLinks = document.querySelectorAll('.nav-link');
        
        function adjustTextareaHeight() {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        textarea.addEventListener('input', adjustTextareaHeight);

        function switchView(viewId) {
            mainViews.forEach(view => view.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(viewId)?.classList.add('active');
            document.getElementById('nav-' + viewId.split('-')[0])?.classList.add('active');

            if (viewId === 'ledger-view') fetchLedgerEntries();
            else if (viewId === 'actions-view') fetchActionItems();
        }
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = link.id.replace('nav-', '') + '-view';
                switchView(viewId);
            });
        });

        function createLoaderElement() {
            const loaderContainer = document.createElement('div');
            loaderContainer.className = 'moon-loader-wrapper';
            loaderContainer.id = 'agent-loader-indicator'; 
            loaderContainer.innerHTML = `<div class="moon"></div>`;
            return loaderContainer;
        }
        function showThinkingAnimation() {
            if (!loaderElement) loaderElement = createLoaderElement();
            messageList.appendChild(loaderElement); 
            sendButton.disabled = true;
            messageList.scrollTop = messageList.scrollHeight;
        }
        function hideThinkingAnimation() {
            if (loaderElement && loaderElement.parentNode === messageList) {
                messageList.removeChild(loaderElement);
            }
            sendButton.disabled = false;
        }

        function pollTaskStatus(taskId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/agent/task_status/${taskId}/`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data.status === 'SUCCESS' || data.status === 'FAILURE') {
                        clearInterval(interval);
                        hideThinkingAnimation();
                        if (data.status === 'SUCCESS') {
                            loadConversation(currentSessionId); 
                            loadChatHistory(); 
                        } else {
                            addMessage('Sorry, an error occurred while processing your request.', 'agent-message', null);
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    hideThinkingAnimation();
                    clearInterval(interval);
                }
            }, 3000);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const prompt = textarea.value.trim();
            if (prompt === '') return;

            addMessage(prompt, 'user-message', null);
            textarea.value = '';
            adjustTextareaHeight();
            
            sendButton.disabled = true;
            showThinkingAnimation();
            
            try {
                const response = await fetch('/agent/ask/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken.value },
                    body: JSON.stringify({ prompt: prompt, session_id: currentSessionId })
                });
                
                if (!response.ok) {
                    if(response.status === 403) showDeleteModal();
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.task_id) {
                    const isNewSession = !currentSessionId && data.session_id;
                    currentSessionId = data.session_id;
                    if (isNewSession) history.pushState({sessionId: currentSessionId}, '', `/agent/${currentSessionId}/`);
                    pollTaskStatus(data.task_id);
                } else {
                    throw new Error('Did not receive a task ID from the server.');
                }
            } catch (error) {
                hideThinkingAnimation();
                sendButton.disabled = false;
                if (!error.message.includes('403')) {
                    addMessage('Sorry, a network error occurred.', 'agent-message', null);
                }
                console.error('Submit error:', error);
            }
        }
        
        async function loadChatHistory() {
            try {
                const response = await fetch('/sessions/');
                if (!response.ok) throw new Error('Failed to load sessions');
                const data = await response.json();
                
                currentSessions = data.sessions;
                sessionCount = currentSessions.length;
                chatCounter.textContent = `${sessionCount} of ${CHAT_LIMIT} Chats in Use`;
                if (chatCounterSidebar) {
                    chatCounterSidebar.textContent = `${sessionCount} of ${CHAT_LIMIT} Chats in Use`;
                }

                sessionList.innerHTML = '';
                currentSessions.forEach(session => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="/agent/${session.id}/" class="session-link" data-session-id="${session.id}">
                            <div class="session-title">${session.title}</div>
                            <p class="session-summary">${session.summary || 'Click to view conversation.'}</p>
                        </a>
                    `;
                    sessionList.appendChild(li);
                });
                
                if (currentSessionId) {
                    document.querySelector(`.session-link[data-session-id="${currentSessionId}"]`)?.classList.add('active');
                }
            } catch (error) {
                console.error("Could not load chat history:", error);
            }
        }
        
        function clearMessageList() { messageList.innerHTML = ''; }

        function loadConversation(sessionId) {
            if (!sessionId) return;
            currentSessionId = sessionId;
            switchView('chat-view');

            document.querySelectorAll('.session-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.session-link[data-session-id="${sessionId}"]`)?.classList.add('active');

            fetch(`/agent/session/${sessionId}/history/`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    clearMessageList();
                    data.history.forEach(message => {
                        // Convert 'model' type to 'agent' for consistency
                        const messageType = message.type === 'model' ? 'agent' : message.type;
                        addMessage(message.text, `${messageType}-message`, message.id);
                    });
                    if (data.history.length === 0) {
                        addMessage("I'm your personal AI Recruiting Strategist. Ask me anything about the recruiting process!", 'agent-message', null);
                    }
                })
                .catch(error => {
                    console.error('Error loading conversation history:', error);
                    clearMessageList();
                    addMessage('Could not load conversation history.', 'agent-message', null); 
                });
        }

        function addMessage(text, className, convId) {
            const messageContainer = document.createElement('div');
            const bubble = document.createElement('div');
            const safeText = text || "";
            const isAgent = className.includes('agent-message');

            messageContainer.className = `message-container ${isAgent ? 'agent-message-wrapper' : 'user-message-wrapper'}`;

            if (isAgent) {
                // Parse markdown and sanitize HTML for agent messages
                try {
                    // Check if libraries are loaded
                    if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                        console.error('Markdown libraries not loaded. Displaying plain text.');
                        bubble.textContent = safeText;
                    } else {
                        // Use marked to parse markdown to HTML, then sanitize
                        const rawHtml = marked.parse(safeText);
                        const sanitizedHtml = DOMPurify.sanitize(rawHtml);
                        bubble.innerHTML = sanitizedHtml;
                    }
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    // Fallback to plain text if markdown parsing fails
                    bubble.textContent = safeText;
                }
            } else {
                // User messages are plain text
                bubble.textContent = safeText;
            }
            bubble.className = `message-bubble ${className}`;

            if (isAgent) {
                const avatar = document.createElement('div');
                avatar.className = 'agent-avatar';
                avatar.textContent = 'CA';
                messageContainer.appendChild(avatar);

                const contentWrapper = document.createElement('div');
                contentWrapper.appendChild(bubble);

                if (convId) {
                    const actionRow = document.createElement('div');
                    actionRow.className = 'ledger-action-row';
                    // Store the ORIGINAL markdown text (before parsing) for the Ledger
                    const contentToSave = safeText;

                    actionRow.innerHTML = `<button class="save-to-ledger-btn" data-conv-id="${convId}" data-content="${encodeURIComponent(contentToSave)}"><span>+</span> Save Insight</button>`;
                    actionRow.querySelector('.save-to-ledger-btn').addEventListener('click', openLedgerModal);
                    contentWrapper.appendChild(actionRow);
                }
                messageContainer.appendChild(contentWrapper);
            } else {
                messageContainer.appendChild(bubble);
            }

            messageList.appendChild(messageContainer);
            messageList.scrollTop = messageList.scrollHeight;
        }

        function showDeleteModal() {
            deletableSessionsList.innerHTML = '';
            currentSessions.forEach(session => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${session.title}</span><button class="delete-session-btn" data-session-id="${session.id}">Delete</button>`;
                deletableSessionsList.appendChild(li);
            });
            deleteModal.classList.add('visible');
        }
        function hideDeleteModal() { deleteModal.classList.remove('visible'); }
        
        async function handleDeleteSession(sessionId) {
            if (!confirm('Are you sure you want to permanently delete this chat?')) return;
            try {
                const response = await fetch(`/agent/session/${sessionId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken.value } });
                if (!response.ok) throw new Error('Failed to delete session');
                const data = await response.json();
                if (data.status === 'success') {
                    hideDeleteModal();
                    if (currentSessionId === sessionId) { window.location.href = '/agent/'; } 
                    else { loadChatHistory(); }
                } else { throw new Error(data.message || 'Deletion failed'); }
            } catch (error) {
                console.error('Deletion error:', error);
                alert('Could not delete the session.');
            }
        }

        function openLedgerModal(event) {
            const button = event.currentTarget;
            if(button.classList.contains('saved')) return; 
            currentConversationId = button.dataset.convId;
            ledgerTitleInput.value = '';
            ledgerContentArea.value = decodeURIComponent(button.dataset.content);
            ledgerModal.classList.add('visible');
        }
        closeLedgerModal.addEventListener('click', () => ledgerModal.classList.remove('visible'));

        confirmSaveLedger.addEventListener('click', async () => {
            const title = ledgerTitleInput.value.trim();
            if (!title) { alert("Please provide a title."); return; }
            
            confirmSaveLedger.disabled = true;
            confirmSaveLedger.textContent = 'Saving...';
            
            try {
                const response = await fetch('/ledger/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken.value },
                    body: JSON.stringify({ conversation_id: currentConversationId, title: title, content: ledgerContentArea.value.trim() })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    const button = document.querySelector(`.save-to-ledger-btn[data-conv-id="${currentConversationId}"]`);
                    if (button) {
                        button.innerHTML = '✔ Added to Ledger';
                        button.classList.add('saved');
                    }
                    ledgerModal.classList.remove('visible');
                    if (ledgerView.classList.contains('active')) fetchLedgerEntries();
                } else { alert('Error: ' + data.message); }
            } catch (error) {
                alert('Network error while saving.');
            } finally {
                confirmSaveLedger.disabled = false;
                confirmSaveLedger.textContent = 'Save to Ledger';
            }
        });
        
        async function fetchLedgerEntries() {
            ledgerEntriesContainer.innerHTML = '<p>Loading...</p>';
            try {
                const response = await fetch('/ledger/');
                const data = await response.json();
                ledgerEntriesContainer.innerHTML = '';
                if (data.ledger_entries && data.ledger_entries.length > 0) {
                    data.ledger_entries.forEach(entry => ledgerEntriesContainer.appendChild(createLedgerEntryElement(entry)));
                } else {
                    ledgerEntriesContainer.innerHTML = '<p>Your Ledger is empty. Save key advice from Coach Alex!</p>';
                }
            } catch (e) { ledgerEntriesContainer.innerHTML = '<p>Error loading Ledger entries.</p>'; }
        }
        
        function createLedgerEntryElement(entry) {
            const div = document.createElement('div');
            div.className = 'ledger-entry';
            const date = new Date(entry.created_at).toLocaleDateString();

            // Parse markdown content for display
            let contentHtml = entry.content;
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                try {
                    const rawHtml = marked.parse(entry.content);
                    contentHtml = DOMPurify.sanitize(rawHtml);
                } catch (error) {
                    console.error('Error parsing markdown in Ledger entry:', error);
                    contentHtml = entry.content; // Fallback to plain text
                }
            }

            div.innerHTML = `
                <h4>${entry.title}</h4>
                <p class="meta">Saved: ${date}</p>
                <div class="ledger-content">${contentHtml}</div>
                <div class="ledger-actions">
                    <button class="generate-actions-btn" data-entry-id="${entry.id}">Generate Action Items</button>
                    <button class="delete-ledger-btn" data-entry-id="${entry.id}">Delete</button>
                </div>
            `;
            div.querySelector('.generate-actions-btn').addEventListener('click', handleGenerateActionItems);
            div.querySelector('.delete-ledger-btn').addEventListener('click', handleDeleteLedgerEntry);
            return div;
        }

        async function handleDeleteLedgerEntry(event) {
            const entryId = event.target.dataset.entryId;
            if (!confirm("Delete this insight?")) return;
            const response = await fetch(`/ledger/${entryId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken.value }});
            const data = await response.json();
            if (data.status === 'success') fetchLedgerEntries();
            else alert('Error deleting insight.');
        }

        async function handleGenerateActionItems(event) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Generating...';
            try {
                const response = await fetch('/action-items/generate/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken.value },
                    body: JSON.stringify({ ledger_entry_id: button.dataset.entryId })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    setTimeout(() => switchView('actions-view'), 500); 
                } else {
                    alert('Error: ' + data.message);
                    button.disabled = false;
                    button.textContent = 'Generate Action Items';
                }
            } catch (error) {
                alert('Network error during generation request.');
                button.disabled = false;
                button.textContent = 'Generate Action Items';
            }
        }

        async function fetchActionItems() {
            activeActionsContainer.innerHTML = '<p>Loading...</p>';
            completedActionsContainer.innerHTML = '';
            try {
                const response = await fetch('/action-items/');
                const data = await response.json();
                activeActionsContainer.innerHTML = '';
                completedActionsContainer.innerHTML = '';
                if (data.active_items.length === 0) activeActionsContainer.innerHTML = '<p>No active tasks. Generate some from your Ledger!</p>';
                data.active_items.forEach(item => activeActionsContainer.appendChild(createActionItemElement(item)));
                if (data.completed_items.length === 0) completedActionsContainer.innerHTML = '<p>No tasks completed yet.</p>';
                data.completed_items.forEach(item => completedActionsContainer.appendChild(createActionItemElement(item)));
            } catch (e) { activeActionsContainer.innerHTML = '<p>Error loading Action Items.</p>'; }
        }

        function createActionItemElement(item) {
            const div = document.createElement('div');
            div.className = item.is_complete ? 'action-item completed' : 'action-item';
            div.innerHTML = `<input type="checkbox" ${item.is_complete ? 'checked' : ''} data-item-id="${item.id}"><span class="action-item-desc">${item.description}</span>`;
            div.querySelector('input').addEventListener('change', handleToggleComplete);
            return div;
        }
        
        async function handleToggleComplete(event) {
            const itemId = event.target.dataset.itemId;
            const response = await fetch(`/action-items/${itemId}/toggle/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken.value }});
            const data = await response.json();
            if (data.status === 'success') fetchActionItems();
            else { alert('Error updating status.'); event.target.checked = !event.target.checked; }
        }
        
        sessionList.addEventListener('click', function(event) {
            const link = event.target.closest('.session-link');
            if (link) {
                event.preventDefault(); 
                const sessionId = link.dataset.sessionId;
                history.pushState({sessionId: sessionId}, '', `/agent/${sessionId}/`);
                loadConversation(sessionId);
            }
        });
        newChatBtn.addEventListener('click', () => {
            if (sessionCount >= CHAT_LIMIT) { showDeleteModal(); return; }
            history.pushState({}, '', '/agent/');
            currentSessionId = null;
            clearMessageList();
            document.querySelectorAll('.session-link').forEach(link => link.classList.remove('active'));
            addMessage("I'm your personal AI Recruiting Strategist. Ask me anything!", 'agent-message', null);
            switchView('chat-view');
        });
        modalCancelBtn.addEventListener('click', hideDeleteModal);
        deletableSessionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-session-btn')) { handleDeleteSession(e.target.dataset.sessionId); }
        });
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit', {cancelable: true}));
            }
        });
        form.addEventListener('submit', handleFormSubmit);

        // DEVELOPMENT ONLY - Reset Data Functionality
        const devResetBtn = document.getElementById('dev-reset-btn');
        const resetModal = document.getElementById('reset-modal');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const resetConfirmationInput = document.getElementById('reset-confirmation-input');

        function showResetModal() {
            resetConfirmationInput.value = '';
            resetModal.classList.add('visible');
        }

        function hideResetModal() {
            resetModal.classList.remove('visible');
        }

        devResetBtn.addEventListener('click', showResetModal);
        cancelResetBtn.addEventListener('click', hideResetModal);

        confirmResetBtn.addEventListener('click', async () => {
            const confirmation = resetConfirmationInput.value.trim();

            if (!confirmation) {
                alert('Please type your username to confirm.');
                return;
            }

            confirmResetBtn.disabled = true;
            confirmResetBtn.textContent = 'DELETING...';

            try {
                const response = await fetch('/dev/reset-my-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken.value
                    },
                    body: JSON.stringify({ confirmation: confirmation })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('✅ All data deleted! Reloading page as fresh user...');
                    window.location.href = '/agent/';
                } else {
                    alert('Error: ' + data.message);
                    confirmResetBtn.disabled = false;
                    confirmResetBtn.textContent = 'DELETE EVERYTHING';
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('Network error during reset.');
                confirmResetBtn.disabled = false;
                confirmResetBtn.textContent = 'DELETE EVERYTHING';
            }
        });

        // ADMIN FUNCTIONALITY - Untethered Mode Toggle
        const adminToggle = document.getElementById('admin-untethered-toggle');
        if (adminToggle) {
            adminToggle.addEventListener('change', async (e) => {
                const isEnabled = e.target.checked;
                try {
                    const response = await fetch('/admin/toggle-untethered/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken.value
                        },
                        body: JSON.stringify({ enabled: isEnabled })
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        console.log(`[ADMIN] Untethered mode ${isEnabled ? 'enabled' : 'disabled'}`);
                    } else {
                        alert('Error toggling untethered mode: ' + data.message);
                        e.target.checked = !isEnabled; // Revert toggle
                    }
                } catch (error) {
                    console.error('Error toggling untethered mode:', error);
                    alert('Network error during toggle.');
                    e.target.checked = !isEnabled; // Revert toggle
                }
            });
        }

        const pathParts = window.location.pathname.split('/').filter(part => part);
        const initialSessionId = pathParts.length > 1 && pathParts[0] === 'agent' ? pathParts[1] : null;

        if (initialSessionId) {
            loadConversation(initialSessionId);
        } else {
            clearMessageList();
            addMessage("Welcome! Select a conversation or start a new one.", 'agent-message', null);
        }
        loadChatHistory();
        switchView('chat-view');
    });
    </script>
</body>
</html>

